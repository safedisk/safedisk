#!/bin/bash

function error_exit
{
	echo "$1" 1>&2
	exit 1
}

[[ $# -eq 1 ]] || error_exit "usage: make_safedisk <storage_path>"

storage_path=$1
size_MB=`cat $storage_path/size`

[[ $size_MB -gt 0 && $size_MB -le 1000000 ]] || error_exit "Size in MB is not in range"

out/release/safedisk $storage_path/fuse_mnt $storage_path/data $size_MB || error_exit "Unable to mnt fuse"

#TODO: If the following errors *or* whenever user ejects drive, we need to unmount $storage_path/fuse_mnt
# The error is easy, not sure how to wait for user eject.

hdiutil attach -imagekey diskimage-class=CRawDiskImage $storage_path/fuse_mnt/data
